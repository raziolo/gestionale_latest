<div class="navbar bg-base-300">
  <div class="navbar-start">
    <!-- (Other dropdowns remain unchanged) -->
    <div class="dropdown">
      <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
        <box-icon name="calendar"></box-icon>
      </div>
      <ul tabindex="0" class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow">
        <li><a>Tutti gli Orari</a></li>
        <li><a>Nuovo Orario</a></li>
      </ul>
    </div>
    <div class="dropdown">
      <div tabindex="1" role="button" class="btn btn-ghost btn-circle">
        <box-icon name="hard-hat"></box-icon>
      </div>
      <ul tabindex="1" class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow">
        <li><a href="{% url 'all_employees' %}">Tutti i Dipendenti</a></li>
        <li><a href="{% url 'new_employee' %}">Nuovo Dipendente</a></li>
      </ul>
    </div>
    <div class="dropdown">
      <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
        <box-icon name="import"></box-icon>
      </div>
      <ul tabindex="0" class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow">
        <li><a href="{% url 'import' %}">Importa Dati</a></li>
        <li><a href="{% url 'import_history' %}">Storico Imports</a></li>
      </ul>
    </div>
  </div>

  <div class="navbar-center">
    <a class="btn btn-ghost text-xl" href="{% url 'config' %}">Gestionale</a>
  </div>

  <div class="navbar-end">
    <!-- Branch Filter Dropdown -->
    <div class="dropdown dropdown-end" id="branchFilterDropdown">
      <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
        <box-icon name="buildings"></box-icon>
      </div>
      <div id="branchDropdownContent" tabindex="0" class="dropdown-content bg-base-100 rounded-box shadow-lg w-80 p-4 z-50 overflow-visible">
        <h2 class="text-sm font-bold mb-2">Report Sede</h2>
        <form>
          {% csrf_token %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text">Sede</span>
            </label>
            <select class="select select-bordered" id="BranchFilter">
              <option disabled selected>Seleziona Sede</option>
              {% for branch in branches %}
                <option value="{{ branch.id }}">{{ branch.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text">Select Date</span>
            </label>
            <input id="BranchFilterdatePicker" type="text" class="input input-bordered w-full" autocomplete="off"/>
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button id="BranchClearBtn" class="btn btn-sm btn-secondary">Clear</button>
            <button id="BranchApplyBtn" class="btn btn-sm btn-primary">Apply</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Employee Filter Dropdown -->
    <div class="dropdown dropdown-end" id="employeeFilterDropdown">
      <button class="btn btn-ghost btn-circle">
        <box-icon name="group"></box-icon>
      </button>
      <div id="employeeDropdownContent" tabindex="0" class="dropdown-content bg-base-100 rounded-box shadow-lg w-80 p-4 z-50 overflow-visible">
        <h2 class="text-sm font-bold mb-2">Report Dipendenti</h2>
        <form>
          {% csrf_token %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text">Sede</span>
            </label>
            <select class="select select-bordered" id="EmployeesBranchFilter">
              <option disabled selected>Seleziona Sede</option>
              {% for branch in branches %}
                <option value="{{ branch.id }}">{{ branch.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text">Seleziona Date</span>
            </label>
            <input id="EmployeeFilterdatePicker" type="text" class="input input-bordered w-full" autocomplete="off"/>
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button id="employeeClearBtn" class="btn btn-sm btn-secondary">Clear</button>
            <button id="employeeApplyBtn" class="btn btn-sm btn-primary">Apply</button>
          </div>
        </form>
      </div>
    </div>

    {% include "frontend/base_cms/themeToggle.html" %}
  </div>
</div>

{% block custom_js %}
<script>
// Wait for the DOM to fully load
document.addEventListener("DOMContentLoaded", function() {
  // -------------------------
  // Branch Filter Dropdown
  // -------------------------
  const branchDropdownContent = document.getElementById("branchDropdownContent");
  const branchDropdown = document.getElementById("branchFilterDropdown");
  const branchApplyBtn = document.getElementById("BranchApplyBtn");
  const branchClearBtn = document.getElementById("BranchClearBtn");

  // Initialize Flatpickr for branch filter
  flatpickr("#BranchFilterdatePicker", {
    mode: "range",
    dateFormat: "Y-m-d",
    allowInput: true,
    appendTo: branchDropdownContent,
    static: true
  });

  // Prevent dropdown from closing when clicking inside its content
  branchDropdownContent.addEventListener("click", function(event) {
    event.stopPropagation();
  });

  // Close branch dropdown when clicking outside
  document.addEventListener("click", function(event) {
    if (!branchDropdown.contains(event.target)) {
      branchDropdownContent.classList.remove("dropdown-open");
    }
  });

  branchApplyBtn.addEventListener("click", function(event) {
    event.preventDefault(); // Prevent form submission
    branchDropdownContent.classList.remove("dropdown-open");
    console.log("Filter applied for branch!");
    sendBranchFilterData();
  });

  branchClearBtn.addEventListener("click", function(event) {
    event.preventDefault(); // Prevent form submission
    branchDropdownContent.classList.remove("dropdown-open");
    console.log("Filter cleared for branch!");
    // Reset the branch filter form
    document.getElementById("BranchFilter").selectedIndex = 0;
    document.getElementById("BranchFilterdatePicker").value = "";
  });

  // -------------------------
  // Employee Filter Dropdown
  // -------------------------
  const employeeDropdownContent = document.getElementById("employeeDropdownContent");
  const employeeDropdown = document.getElementById("employeeFilterDropdown");
  const employeeApplyBtn = document.getElementById("employeeApplyBtn");
  const employeeClearBtn = document.getElementById("employeeClearBtn");

  // Initialize Flatpickr for employee filter
  flatpickr("#EmployeeFilterdatePicker", {
    mode: "range",
    dateFormat: "Y-m-d",
    allowInput: true,
    appendTo: employeeDropdownContent,
    static: true
  });

  // Prevent employee dropdown from closing when clicking inside its content
  employeeDropdownContent.addEventListener("click", function(event) {
    event.stopPropagation();
  });

  // Close employee dropdown when clicking outside
  document.addEventListener("click", function(event) {
    if (!employeeDropdown.contains(event.target)) {
      employeeDropdownContent.classList.remove("dropdown-open");
    }
  });

  employeeApplyBtn.addEventListener("click", function(event) {
    event.preventDefault(); // Prevent form submission
    employeeDropdownContent.classList.remove("dropdown-open");
    console.log("Filter applied for employees!");
    sendEmployeeFilterData();
  });

  employeeClearBtn.addEventListener("click", function(event) {
    event.preventDefault(); // Prevent form submission
    employeeDropdownContent.classList.remove("dropdown-open");
    console.log("Filter cleared for employees!");
    // Reset the employee filter form
    document.getElementById("EmployeesBranchFilter").selectedIndex = 0;
    document.getElementById("EmployeeFilterdatePicker").value = "";
  });
});

// Function to send branch filter data via AJAX
function sendBranchFilterData() {
  const selectedBranch = document.getElementById("BranchFilter").value;
  const date = document.getElementById("BranchFilterdatePicker").value;
  console.log("Branch Filter - Branch:", selectedBranch);
  console.log("Branch Filter - Date:", date);

  // Show a loading indicator using SweetAlert2
  Swal.fire({
    title: 'Attendere...',
    text: 'Generazione Report...',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  fetch('{% url "filter" %}', {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      type: 'branch',
      branch: selectedBranch,
      date: date,
    }),
  })
    .then((response) => response.json())
    .then((data) => {
      Swal.close();
      if (data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        Swal.fire("Error", "No redirect URL received.", "error");
      }
    })
    .catch((error) => {
      Swal.close();
      console.error("Error:", error);
      Swal.fire("Error", "An error occurred while generating the report.", "error");
    });
}

// Function to send employee filter data via AJAX
function sendEmployeeFilterData() {
  const selectedBranch = document.getElementById("EmployeesBranchFilter").value;
  const date = document.getElementById("EmployeeFilterdatePicker").value;
  console.log("Employee Filter - Branch:", selectedBranch);
  console.log("Employee Filter - Date:", date);

  // Show a loading indicator using SweetAlert2
  Swal.fire({
    title: 'Please wait...',
    text: 'Generating report...',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  fetch('{% url "filter" %}', {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      type: 'employees',
      branch: selectedBranch,
      date: date,
    }),
  })
    .then((response) => response.json())
    .then((data) => {
      Swal.close();
      if (data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        Swal.fire("Error", "No redirect URL received.", "error");
      }
    })
    .catch((error) => {
      Swal.close();
      console.error("Error:", error);
      Swal.fire("Error", "An error occurred while generating the report.", "error");
    });
}
</script>
{% endblock custom_js %}
